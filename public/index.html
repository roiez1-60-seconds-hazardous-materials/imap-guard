<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#f2f2f7">
<title>iMap Guard - × ×™×•×•×˜ ×—×™×¨×•×</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Secular+One&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#f2f2f7;--card:rgba(255,255,255,0.88);--card-solid:#fff;--card-hover:rgba(255,255,255,0.95);
  --text:#1c1c1e;--text2:#3a3a3c;--text3:#8e8e93;--text4:#aeaeb2;
  --sep:rgba(60,60,67,0.08);--sep-heavy:rgba(60,60,67,0.18);
  --blue:#007aff;--blue-light:rgba(0,122,255,0.1);--blue-glow:rgba(0,122,255,0.25);
  --green:#34c759;--orange:#ff9500;--red:#ff3b30;--red-light:rgba(255,59,48,0.1);
  --purple:#af52de;--purple-light:rgba(175,82,222,0.1);
  --radius:18px;--radius-md:14px;--radius-sm:10px;
  --blur:saturate(180%) blur(20px);--blur-heavy:saturate(200%) blur(40px);
  --shadow-sm:0 1px 3px rgba(0,0,0,0.04);--shadow-md:0 4px 20px rgba(0,0,0,0.06);--shadow-lg:0 8px 40px rgba(0,0,0,0.08);
  --safe-bottom:max(env(safe-area-inset-bottom,0px),12px);
}
html,body{height:100%;width:100%;overflow:hidden;position:fixed;top:0;left:0}
body{font-family:'Heebo',-apple-system,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
#map{width:100%;height:100%;position:absolute;top:0;left:0;z-index:1}

/* Splash */
.splash{position:fixed;inset:0;z-index:3000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .7s}
.splash.hidden{opacity:0;pointer-events:none}
.splash-logo{width:72px;height:72px;border-radius:18px;background:linear-gradient(145deg,#007aff,#0055d4);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 32px rgba(0,122,255,0.25);margin-bottom:20px;animation:pop .6s cubic-bezier(.34,1.56,.64,1) forwards;opacity:0}
@keyframes pop{0%{opacity:0;transform:scale(.5)}100%{opacity:1;transform:scale(1)}}
.splash-logo svg{width:36px;height:36px;color:white}
.splash-title{font-family:'Secular One',sans-serif;font-size:28px;color:var(--text);margin-bottom:4px;animation:fadeUp .6s .15s ease forwards;opacity:0}
.splash-sub{font-size:14px;color:var(--text3);margin-bottom:32px;animation:fadeUp .6s .25s ease forwards;opacity:0}
@keyframes fadeUp{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}
.splash-spinner{width:32px;height:32px;border:3px solid var(--sep-heavy);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite,fadeUp .4s .35s ease forwards;opacity:0}
@keyframes spin{to{transform:rotate(360deg)}}
.splash-status{margin-top:16px;font-size:13px;color:var(--text4);animation:fadeUp .4s .4s ease forwards;opacity:0}

/* Top Bar */
.topbar{position:fixed;top:0;left:0;right:0;z-index:1000;min-height:54px;padding:env(safe-area-inset-top,8px) 16px 8px;display:flex;align-items:flex-end;justify-content:space-between;background:rgba(242,242,247,0.78);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-bottom:0.5px solid var(--sep)}
.source-pill{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.7);padding:6px 14px 6px 10px;border-radius:22px;border:0.5px solid var(--sep);box-shadow:var(--shadow-sm);transition:all .3s}
.source-pill.gps .pill-dot{background:var(--green);box-shadow:0 0 6px rgba(52,199,89,0.5)}
.source-pill.cell .pill-dot{background:var(--orange);box-shadow:0 0 6px rgba(255,149,0,0.5)}
.source-pill.dr .pill-dot{background:var(--purple);box-shadow:0 0 6px rgba(175,82,222,0.5)}
.source-pill.none .pill-dot{background:var(--red);box-shadow:0 0 6px rgba(255,59,48,0.5)}
.pill-dot{width:8px;height:8px;border-radius:50%;transition:all .3s;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.55;transform:scale(.85)}}
.pill-label{font-size:13px;font-weight:600;color:var(--text2);white-space:nowrap}
.topbar-right{display:flex;align-items:center;gap:8px}
.acc-chip{font-size:12px;font-weight:600;color:var(--text3);background:rgba(255,255,255,0.65);padding:6px 12px;border-radius:18px;border:0.5px solid var(--sep)}
.about-btn{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.65);border:0.5px solid var(--sep);display:flex;align-items:center;justify-content:center;cursor:pointer;text-decoration:none;font-size:16px;color:var(--text3);transition:all .15s}
.about-btn:active{background:rgba(255,255,255,0.9);transform:scale(.9)}

/* Spoof Alert */
.spoof-alert{position:fixed;top:62px;left:14px;right:14px;z-index:1002;display:none;background:linear-gradient(135deg,rgba(255,59,48,0.12),rgba(255,59,48,0.04));border:1px solid rgba(255,59,48,0.25);border-radius:var(--radius-md);padding:12px 14px;gap:10px;align-items:center;box-shadow:var(--shadow-md);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);animation:alertPulse 2s ease infinite}
.spoof-alert.active{display:flex}
@keyframes alertPulse{0%,100%{border-color:rgba(255,59,48,0.25)}50%{border-color:rgba(255,59,48,0.5)}}
.spoof-icon{width:36px;height:36px;border-radius:10px;background:var(--red-light);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:20px}
.spoof-info{flex:1}
.spoof-title{font-size:13px;font-weight:700;color:var(--red)}
.spoof-detail{font-size:11px;color:var(--text3);margin-top:2px}
.spoof-reasons{font-size:10px;color:var(--text4);margin-top:3px}

/* DR Banner */
.dr-banner{position:fixed;top:62px;left:14px;right:14px;z-index:1001;display:none;background:linear-gradient(135deg,rgba(175,82,222,0.12),rgba(175,82,222,0.05));border:1px solid rgba(175,82,222,0.2);border-radius:var(--radius-md);padding:10px 14px;gap:10px;align-items:center;box-shadow:var(--shadow-md);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur)}
.dr-banner.active{display:flex}
.dr-icon{width:32px;height:32px;border-radius:8px;background:var(--purple-light);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px}
.dr-info{flex:1}
.dr-title{font-size:12px;font-weight:700;color:var(--purple)}
.dr-detail{font-size:11px;color:var(--text3);margin-top:1px}
.dr-confidence{width:50px;height:6px;border-radius:3px;background:rgba(0,0,0,0.06);overflow:hidden;flex-shrink:0}
.dr-conf-fill{height:100%;border-radius:3px;background:var(--purple);transition:width .5s}

/* Search */
.search-area{position:fixed;top:62px;left:14px;right:14px;z-index:999;transition:top .3s}
.search-area.shifted{top:114px}
.search-field{display:flex;align-items:center;gap:12px;background:var(--card);backdrop-filter:var(--blur-heavy);-webkit-backdrop-filter:var(--blur-heavy);border-radius:var(--radius);padding:0 18px;border:0.5px solid var(--sep);box-shadow:var(--shadow-md);transition:all .3s}
.search-field:focus-within{box-shadow:var(--shadow-md),0 0 0 3px var(--blue-glow);border-color:rgba(0,122,255,0.3)}
.search-field svg{flex-shrink:0;color:var(--text4);transition:color .2s}
.search-field:focus-within svg{color:var(--blue)}
.search-field input{flex:1;border:none;background:none;font-family:inherit;font-size:16px;padding:15px 0;outline:none;color:var(--text);direction:rtl;font-weight:500}
.search-field input::placeholder{color:var(--text4);font-weight:400}
.results-list{margin-top:8px;background:var(--card);backdrop-filter:var(--blur-heavy);-webkit-backdrop-filter:var(--blur-heavy);border-radius:var(--radius);border:0.5px solid var(--sep);box-shadow:var(--shadow-lg);max-height:240px;overflow-y:auto;display:none}
.results-list.open{display:block}
.result-row{padding:13px 18px;cursor:pointer;border-bottom:0.5px solid var(--sep);display:flex;align-items:center;gap:12px;transition:background .12s}
.result-row:active{background:rgba(0,122,255,0.05)}
.result-row:last-child{border:none}
.result-icon{width:34px;height:34px;border-radius:10px;background:var(--blue-light);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:15px}
.result-text{flex:1;min-width:0}
.result-name{font-size:15px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.result-addr{font-size:12px;color:var(--text3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Side Controls */
.side-controls{position:fixed;top:128px;left:14px;z-index:998;display:flex;flex-direction:column;gap:8px;transition:top .3s}
.side-controls.shifted{top:178px}
.ctrl-btn{width:48px;height:48px;border-radius:var(--radius-md);background:var(--card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:0.5px solid var(--sep);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--shadow-md);transition:all .2s}
.ctrl-btn:active{transform:scale(.88);background:var(--card-hover)}
.compass-svg{transition:transform .35s}

/* Bottom Sheet */
.sheet{position:fixed;bottom:0;left:0;right:0;z-index:999;background:var(--card);backdrop-filter:var(--blur-heavy);-webkit-backdrop-filter:var(--blur-heavy);border-radius:22px 22px 0 0;border-top:0.5px solid var(--sep);box-shadow:0 -4px 32px rgba(0,0,0,0.06);padding:6px 18px var(--safe-bottom)}
.sheet-grip{width:36px;height:5px;border-radius:3px;background:rgba(0,0,0,0.1);margin:4px auto 14px}

/* Nav Panel */
.nav-panel{display:none;margin-bottom:14px}
.nav-panel.active{display:block;animation:navSlide .3s ease}
@keyframes navSlide{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}
.nav-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.nav-info{flex:1}
.nav-label{font-size:12px;color:var(--text3);margin-bottom:3px}
.nav-distance{font-size:32px;font-weight:900;color:var(--blue);line-height:1;letter-spacing:-1px}
.nav-time{font-size:14px;color:var(--text2);font-weight:600;margin-top:4px}
.nav-bearing{font-size:13px;color:var(--text3);margin-top:2px}
.nav-dismiss{width:32px;height:32px;border-radius:50%;background:rgba(0,0,0,0.05);border:none;font-size:16px;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center}
.nav-dismiss:active{background:rgba(0,0,0,0.1);transform:scale(.9)}

/* Route mode selector */
.route-modes{display:flex;gap:6px;margin-bottom:10px}
.route-mode{flex:1;padding:8px;border-radius:var(--radius-sm);border:1.5px solid var(--sep);background:var(--bg);font-family:inherit;font-size:13px;font-weight:600;color:var(--text3);cursor:pointer;text-align:center;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:5px}
.route-mode.active{border-color:var(--blue);background:var(--blue-light);color:var(--blue)}
.route-mode:active{transform:scale(.96)}

/* Nav card wrapper */
.nav-card-bg{background:linear-gradient(135deg,rgba(0,122,255,0.06),rgba(0,122,255,0.02));border:1px solid rgba(0,122,255,0.12);border-radius:var(--radius);padding:14px 16px;overflow:hidden;position:relative}
.nav-card-bg::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;border-radius:50%;background:rgba(0,122,255,0.06)}

/* Metrics */
.metrics{display:flex;gap:8px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.metrics::-webkit-scrollbar{display:none}
.metric-card{flex:1;min-width:68px;background:var(--bg);border-radius:var(--radius-md);padding:10px 6px;text-align:center}
.metric-label{font-size:9px;color:var(--text4);font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
.metric-value{font-size:20px;font-weight:800;color:var(--text);line-height:1.1;transition:color .3s}
.metric-unit{font-size:10px;color:var(--text3);margin-top:2px}

/* Actions */
.actions{display:flex;gap:10px}
.action-btn{flex:1;padding:15px;border-radius:var(--radius);border:none;font-family:inherit;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;-webkit-appearance:none;position:relative;overflow:hidden}
.action-btn:active{transform:scale(.96)}
.action-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.15),transparent);pointer-events:none}
.btn-locate{background:var(--blue);color:white;box-shadow:0 4px 16px rgba(0,122,255,0.25)}
.btn-track{background:var(--card-solid);color:var(--text);border:0.5px solid var(--sep);box-shadow:var(--shadow-sm)}
.btn-tracking{background:var(--green);color:white;box-shadow:0 4px 16px rgba(52,199,89,0.25)}

/* Credit */
.credit-bar{position:fixed;bottom:0;left:0;right:0;z-index:1001;pointer-events:none;display:flex;justify-content:center;padding-bottom:calc(var(--safe-bottom) + 2px)}
.credit-tag{pointer-events:auto;background:rgba(0,0,0,0.55);backdrop-filter:blur(16px);padding:5px 14px;border-radius:20px;font-size:10.5px;font-weight:600;color:rgba(255,255,255,0.85);display:flex;align-items:center;gap:5px}
.credit-tag .dot{width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.4)}

/* Toast */
.toast{position:fixed;top:68px;left:50%;z-index:1100;transform:translateX(-50%) translateY(-100px);background:var(--card-solid);border-radius:var(--radius-md);padding:11px 22px;font-size:14px;font-weight:600;color:var(--text);box-shadow:var(--shadow-lg);border:0.5px solid var(--sep);transition:transform .45s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;max-width:92%}
.toast.show{transform:translateX(-50%) translateY(0)}

/* Mapbox overrides */
.mapboxgl-ctrl-attrib{font-size:9px!important;background:rgba(242,242,247,0.75)!important;backdrop-filter:blur(8px)!important;border-radius:6px 0 0 0!important}
.mapboxgl-ctrl-logo{opacity:.6!important}
.mapboxgl-ctrl-bottom-left,.mapboxgl-ctrl-bottom-right{bottom:180px!important}
</style>
</head>
<body>

<div class="splash" id="splash">
  <div class="splash-logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polygon points="3,11 22,2 13,21 11,13"/></svg></div>
  <div class="splash-title">iMap Guard</div>
  <div class="splash-sub">× ×™×•×•×˜ ×—×™×¨×•× Â· Mapbox Â· Dead Reckoning</div>
  <div class="splash-spinner"></div>
  <div class="splash-status" id="splashStatus">×˜×•×¢×Ÿ ××¤×”...</div>
</div>
<div class="toast" id="toast"></div>

<div class="topbar">
  <div class="source-pill" id="sourcePill">
    <div class="pill-dot"></div>
    <span class="pill-label" id="pillLabel">××—×¤×© ××™×§×•×...</span>
  </div>
  <div class="topbar-right">
    <div class="acc-chip" id="accChip">â€”</div>
    <a href="about.html" class="about-btn" title="××•×“×•×ª">â„¹</a>
  </div>
</div>

<div class="spoof-alert" id="spoofAlert">
  <div class="spoof-icon">âš ï¸</div>
  <div class="spoof-info">
    <div class="spoof-title" id="spoofTitle">×–×•×”×” ×©×™×‘×•×© GPS</div>
    <div class="spoof-detail" id="spoofDetail">×”××™×§×•× ××”-GPS ×œ× ×”×’×™×•× ×™ â€” ×¢×•×‘×¨×™× ×œ××™×§×•× ××©×•×¢×¨</div>
    <div class="spoof-reasons" id="spoofReasons"></div>
  </div>
</div>

<div class="dr-banner" id="drBanner">
  <div class="dr-icon">ğŸ§­</div>
  <div class="dr-info">
    <div class="dr-title" id="drTitle">Dead Reckoning ×¤×¢×™×œ</div>
    <div class="dr-detail" id="drDetail">××™×§×•× ××©×•×¢×¨ Â· <span id="drSteps">0</span> ×¦×¢×“×™× Â· <span id="drTime">0</span> ×©× ×³</div>
  </div>
  <div class="dr-confidence"><div class="dr-conf-fill" id="drConf" style="width:100%"></div></div>
</div>

<div class="search-area" id="searchArea">
  <div class="search-field">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="searchInput" placeholder="×—×¤×© ×™×¢×“ â€” ×›×ª×•×‘×ª, ×¢×™×¨, ××§×•×" autocomplete="off" spellcheck="false">
  </div>
  <div class="results-list" id="resultsList"></div>
</div>

<div class="side-controls" id="sideControls">
  <div class="ctrl-btn" id="compassBtn"><svg class="compass-svg" id="compassSvg" width="22" height="22" viewBox="0 0 40 40"><polygon points="20,4 24.5,20 20,17 15.5,20" fill="#ff3b30"/><polygon points="20,36 15.5,20 20,23 24.5,20" fill="#c7c7cc"/></svg></div>
  <div class="ctrl-btn" id="recenterBtn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007aff" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg></div>
  <div class="ctrl-btn" id="trafficBtn" title="×ª× ×•×¢×” ×—×™×”" style="position:relative"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M5 14h14l-1.5-4h-11L5 14z" fill="#34c759" stroke="#34c759" stroke-width="1" stroke-linejoin="round"/><rect x="5" y="14" width="14" height="4" rx="1.5" fill="#2db54c" stroke="#2db54c"/><circle cx="7.5" cy="18" r="1.5" fill="#1a1a1a"/><circle cx="16.5" cy="18" r="1.5" fill="#1a1a1a"/><path d="M17 7.5a3.5 3.5 0 013 1.7" stroke="#ff9500" stroke-width="1.5" stroke-linecap="round"/><path d="M17 4.5a6.5 6.5 0 015.5 3" stroke="#ff3b30" stroke-width="1.5" stroke-linecap="round"/></svg></div>
</div>

<div id="map"></div>

<div class="sheet">
  <div class="sheet-grip"></div>
  <div class="nav-panel" id="navPanel">
    <div class="route-modes">
      <button class="route-mode active" id="modeDrive" data-mode="driving-traffic">ğŸš— × ×¡×™×¢×”</button>
      <button class="route-mode" id="modeWalk" data-mode="walking">ğŸš¶ ×”×œ×™×›×”</button>
    </div>
    <div class="nav-card-bg">
      <div class="nav-header">
        <div class="nav-info">
          <div class="nav-label" id="navLabel">× ×™×•×•×˜ ×œ:</div>
          <div class="nav-distance" id="navDistance">â€”</div>
          <div class="nav-time" id="navTime"></div>
          <div class="nav-bearing" id="navBearing">â€”</div>
        </div>
        <button class="nav-dismiss" id="navDismiss">âœ•</button>
      </div>
    </div>
  </div>
  <div class="metrics">
    <div class="metric-card"><div class="metric-label">××§×•×¨</div><div class="metric-value" id="mSrc" style="font-size:13px">â€”</div></div>
    <div class="metric-card"><div class="metric-label">×“×™×•×§</div><div class="metric-value" id="mAcc">â€”</div><div class="metric-unit">××˜×¨</div></div>
    <div class="metric-card"><div class="metric-label">××”×™×¨×•×ª</div><div class="metric-value" id="mSpd">â€”</div><div class="metric-unit">×§××´×©</div></div>
    <div class="metric-card"><div class="metric-label">×¦×¢×“×™×</div><div class="metric-value" id="mSteps">0</div></div>
    <div class="metric-card"><div class="metric-label">×›×™×•×•×Ÿ</div><div class="metric-value" id="mHdg" style="font-size:13px">â€”</div></div>
    <div class="metric-card"><div class="metric-label">×’×•×‘×”</div><div class="metric-value" id="mAlt">â€”</div><div class="metric-unit">××˜×¨</div></div>
  </div>
  <div class="actions">
    <button class="action-btn btn-locate" id="btnLocate">ğŸ“ ××ª×¨ ××™×§×•×</button>
    <button class="action-btn btn-track" id="btnTrack">ğŸ›°ï¸ ××¢×§×‘ ×¨×¦×™×£</button>
    <button class="action-btn btn-share" id="btnShare" style="flex:.4;background:#25d366;color:white;box-shadow:0 4px 16px rgba(37,211,102,0.25)">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
    </button>
  </div>
</div>

<div class="credit-bar"><div class="credit-tag">×›×œ×™ × ×™×¡×™×•× ×™<span class="dot"></span>×¤×•×ª×— ×¢×´×™ ×¨×•×¢×™ ×¦×•×§×¨××Ÿ</div></div>

<script>
const MAPBOX_TOKEN='pk.eyJ1Ijoicm9pZXoiLCJhIjoiY2t2YjVqeGZpMDNxZDJ4bXB1dWp1MTNocyJ9.3vPeZHCVkHEkxrCz6Eb4OA';
mapboxgl.accessToken=MAPBOX_TOKEN;

/* â•â•â• DR Engine â•â•â• */
const DR={
  active:false,anchor:null,estimated:null,heading:null,steps:0,stride:.75,confidence:100,startTime:0,trail:[],
  _accBuf:[],_lastStep:0,_thresh:1.2,_minInt:280,_decay:null,
  reset(){this.active=false;this.anchor=null;this.estimated=null;this.steps=0;this.confidence=100;this.trail=[];this._accBuf=[];if(this._decay)clearInterval(this._decay)},
  setAnchor(lat,lng){this.anchor={lat,lng,t:Date.now()};this.estimated={lat,lng};this.steps=0;this.confidence=100;this.startTime=Date.now();this.trail=[{lat,lng}]},
  activate(){if(!this.anchor)return false;this.active=true;this.startTime=Date.now();this.steps=0;this.confidence=100;if(this._decay)clearInterval(this._decay);this._decay=setInterval(()=>{if(!this.active)return;this.confidence=Math.max(0,this.confidence-2);this.updateUI()},1000);return true},
  deactivate(){this.active=false;if(this._decay)clearInterval(this._decay)},
  processAccel(x,y,z){if(!this.active)return;const mag=Math.sqrt(x*x+y*y+z*z)/9.81;this._accBuf.push(mag);if(this._accBuf.length>5)this._accBuf.shift();const avg=this._accBuf.reduce((a,b)=>a+b,0)/this._accBuf.length;const now=Date.now();if(avg>this._thresh&&(now-this._lastStep)>this._minInt){this._lastStep=now;this.onStep()}},
  onStep(){this.steps++;if(this.heading===null||!this.estimated)return;const R=6371000,d=this.stride,b=this.heading*Math.PI/180,la=this.estimated.lat*Math.PI/180,lo=this.estimated.lng*Math.PI/180;const la2=Math.asin(Math.sin(la)*Math.cos(d/R)+Math.cos(la)*Math.sin(d/R)*Math.cos(b));const lo2=lo+Math.atan2(Math.sin(b)*Math.sin(d/R)*Math.cos(la),Math.cos(d/R)-Math.sin(la)*Math.sin(la2));this.estimated={lat:la2*180/Math.PI,lng:lo2*180/Math.PI};this.trail.push({...this.estimated});if(this.trail.length>500)this.trail.shift()},
  setHeading(h){this.heading=h},
  elapsed(){return Math.round((Date.now()-this.startTime)/1000)},
  estAcc(){return Math.round(5+this.steps*0.3+this.elapsed()*0.1)},
  updateUI(){document.getElementById('drSteps').textContent=this.steps;document.getElementById('drTime').textContent=this.elapsed();const f=document.getElementById('drConf');f.style.width=this.confidence+'%';f.style.background=this.confidence>60?'var(--purple)':this.confidence>30?'var(--orange)':'var(--red)';document.getElementById('drDetail').innerHTML=`××™×§×•× ××©×•×¢×¨ Â· ${this.steps} ×¦×¢×“×™× Â· ${this.elapsed()} ×©× ×³ Â· Â±${this.estAcc()}m`}
};

/* â•â•â• Spoof Engine â•â•â• */
const Spoof={
  BOUNDS:{minLat:29.4,maxLat:33.4,minLng:34.2,maxLng:35.9},MAX_SPEED:70,
  spoofCount:0,THRESH:2,lastTrusted:null,_motionN:0,_motionSum:0,
  processMotion(x,y,z){const d=Math.abs(Math.sqrt(x*x+y*y+z*z)-9.81);this._motionN++;this._motionSum+=d},
  check(lat,lng,acc,ts,prev){
    const reasons=[];let sev='low';
    if(lat<this.BOUNDS.minLat||lat>this.BOUNDS.maxLat||lng<this.BOUNDS.minLng||lng>this.BOUNDS.maxLng){reasons.push('××™×§×•× ××—×•×¥ ×œ×’×‘×•×œ×•×ª ×™×©×¨××œ');sev='high'}
    if(prev){const dist=this._dist(prev.lat,prev.lng,lat,lng),dt=(ts-prev.t)/1000;if(dt>0&&dt<30){const sp=dist/dt;if(sp>this.MAX_SPEED){reasons.push(`×§×¤×™×¦×”: ${Math.round(dist/1000)} ×§×´× ×‘-${Math.round(dt)} ×©× ×³`);sev=sp>500?'high':'medium'}}}
    if(prev&&this._motionN>10){const dist=this._dist(prev.lat,prev.lng,lat,lng),avg=this._motionSum/this._motionN;if(dist>1000&&avg<0.3){reasons.push('×—×™×™×©× ×™× ×œ× ×–×™×”×• ×ª× ×•×¢×”');if(sev==='low')sev='medium'}}
    if(reasons.length>0)this.spoofCount++;else{this.spoofCount=Math.max(0,this.spoofCount-1);this.lastTrusted={lat,lng,t:ts}}
    if(this._motionN>50){this._motionN=0;this._motionSum=0}
    return{spoofed:this.spoofCount>=this.THRESH,reasons,severity:sev}
  },
  _dist(a,b,c,d){const R=6371000,p=Math.PI/180,dl=(c-a)*p,dn=(d-b)*p,x=Math.sin(dl/2)**2+Math.cos(a*p)*Math.cos(c*p)*Math.sin(dn/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))}
};

/* â•â•â• App â•â•â• */
const App={
  map:null,marker:null,accCircle:null,routeMode:'driving-traffic',
  wId:null,fbW:null,tracking:false,pos:null,heading:null,
  dest:null,hist:[],sTmr:null,ready:false,firstFix:false,
  lastGPSTime:0,drMode:false,_drWatchdog:null,_followHeading:false,

  init(){
    try{
      this.buildMap();this.sensors();this.events();
    }catch(e){console.error(e);document.getElementById('splashStatus').textContent='×©×’×™××”: '+e.message}
  },

  buildMap(){
    this.map=new mapboxgl.Map({
      container:'map',
      style:'mapbox://styles/mapbox/streets-v12',
      center:[35.21,31.77],
      zoom:8,
      pitch:0,
      bearing:0,
      attributionControl:true,
      locale:{'NavigationControl.ZoomIn':'','NavigationControl.ZoomOut':''}
    });

    this.map.on('load',()=>{
      this.ready=true;
      // 3D buildings
      const layers=this.map.getStyle().layers;
      let labelLayerId;
      for(const l of layers){if(l.type==='symbol'&&l.layout['text-field']){labelLayerId=l.id;break}}
      this.map.addLayer({id:'3d-buildings',source:'composite','source-layer':'building',filter:['==','extrude','true'],type:'fill-extrusion',minzoom:14,paint:{'fill-extrusion-color':'#ddd','fill-extrusion-height':['get','height'],'fill-extrusion-base':['get','min_height'],'fill-extrusion-opacity':.5}},labelLayerId);

      // â•â•â• Live Traffic Layer â•â•â•
      this.map.addSource('mapbox-traffic',{type:'vector',url:'mapbox://mapbox.mapbox-traffic-v1'});
      this.map.addLayer({
        id:'traffic-line',type:'line',source:'mapbox-traffic','source-layer':'traffic',
        minzoom:6,
        layout:{'line-join':'round','line-cap':'round'},
        paint:{
          'line-width':['interpolate',['linear'],['zoom'],6,0.5,9,1.5,14,3,18,6],
          'line-color':['match',['get','congestion'],
            'low','#34c759',
            'moderate','#ff9500',
            'heavy','#ff3b30',
            'severe','#af0000',
            'rgba(0,0,0,0)'],
          'line-opacity':0.7,
          'line-offset':['interpolate',['linear'],['zoom'],6,0,9,0.5,14,2,18,4]
        }
      },labelLayerId);
      this._trafficVisible=true;

      // Route source
      this.map.addSource('route',{type:'geojson',data:{type:'Feature',geometry:{type:'LineString',coordinates:[]}}});
      this.map.addLayer({id:'route-line',type:'line',source:'route',layout:{'line-join':'round','line-cap':'round'},paint:{'line-color':'#007aff','line-width':6,'line-opacity':0.75}});

      // DR trail source
      this.map.addSource('dr-trail',{type:'geojson',data:{type:'Feature',geometry:{type:'LineString',coordinates:[]}}});
      this.map.addLayer({id:'dr-trail-line',type:'line',source:'dr-trail',paint:{'line-color':'#af52de','line-width':3,'line-opacity':0.6,'line-dasharray':[2,2]}});

      document.getElementById('splashStatus').textContent='×××ª×¨ ××™×§×•×...';
      this.locate();
      // Check URL params for shared destination
      this._checkSharedLink();
    });

    // User marker element
    const el=document.createElement('div');
    el.id='userMarker';
    el.innerHTML=`<div style="position:relative;width:80px;height:80px">
      <!-- Google Maps style heading cone -->
      <div id="uCone" style="position:absolute;top:0;left:50%;transform-origin:50% 50%;transform:translateX(-50%);
        width:80px;height:80px;display:none;z-index:1;pointer-events:none">
        <svg width="80" height="80" viewBox="0 0 80 80">
          <defs>
            <radialGradient id="coneGrad" cx="50%" cy="100%" r="80%" fx="50%" fy="100%">
              <stop offset="0%" stop-color="rgba(66,133,244,0.35)"/>
              <stop offset="100%" stop-color="rgba(66,133,244,0)"/>
            </radialGradient>
          </defs>
          <path d="M40,40 L15,2 L65,2 Z" fill="url(#coneGrad)"/>
        </svg>
      </div>
      <!-- Pulse ring -->
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:28px;height:28px;border-radius:50%;background:rgba(66,133,244,.08);animation:uRing 2.2s ease-out infinite"></div>
      <!-- Core dot -->
      <div id="uCore" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
        width:22px;height:22px;border-radius:50%;
        background:linear-gradient(180deg,#4285f4,#1a6dea);
        border:3px solid white;
        box-shadow:0 1px 8px rgba(66,133,244,.5),0 0 0 1px rgba(66,133,244,.08);z-index:3;transition:all .5s"></div>
    </div><style>@keyframes uRing{0%{transform:scale(.6);opacity:.7}100%{transform:scale(2.5);opacity:0}}</style>`;
    this.marker=new mapboxgl.Marker({element:el,anchor:'center'}).setLngLat([0,0]);
  },

  sensors(){
    const goOri=()=>window.addEventListener('deviceorientation',e=>{
      let h=e.webkitCompassHeading!==undefined?e.webkitCompassHeading:e.alpha!==null?(360-e.alpha)%360:null;
      if(h!==null){
        this.heading=h;DR.setHeading(h);
        const c=document.getElementById('compassSvg');if(c)c.style.transform=`rotate(${h}deg)`;
        // Rotate heading cone (Google Maps style)
        const cone=document.getElementById('uCone');
        if(cone){cone.style.display='block';cone.style.transform=`translateX(-50%) rotate(${h}deg)`}
        // Rotate map when follow-heading is active
        if(this._followHeading&&this.ready){
          this.map.easeTo({bearing:-h,duration:150,easing:t=>t});
        }
      }
    },true);
    const goMotion=()=>window.addEventListener('devicemotion',e=>{
      if(e.accelerationIncludingGravity){const{x,y,z}=e.accelerationIncludingGravity;DR.processAccel(x||0,y||0,z||0);Spoof.processMotion(x||0,y||0,z||0);if(DR.active&&DR.estimated)this.renderDR()}
    },true);
    if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
      document.addEventListener('click',()=>{DeviceOrientationEvent.requestPermission().then(s=>{if(s==='granted')goOri()}).catch(()=>{});DeviceMotionEvent.requestPermission().then(s=>{if(s==='granted')goMotion()}).catch(()=>{})},{once:true});
    }else{goOri();goMotion()}
  },

  locate(){
    if(!navigator.geolocation){this.toast('âš ï¸ ×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘××™×§×•×');this.hideSplash();return}
    navigator.geolocation.getCurrentPosition(p=>this.onPos(p),()=>{
      navigator.geolocation.getCurrentPosition(p=>this.onPos(p),()=>{this.hideSplash();this.toast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ××ª×¨ ××™×§×•×');this.setSource('××™×Ÿ ××™×§×•×','none')},
      {enableHighAccuracy:false,timeout:20000,maximumAge:300000});
    },{enableHighAccuracy:true,timeout:15000,maximumAge:0});
    navigator.geolocation.getCurrentPosition(p=>{if(!this.pos)this.onPos(p)},()=>{},{enableHighAccuracy:false,timeout:10000,maximumAge:60000});
  },

  startTrack(){
    if(this.tracking){this.stopTrack();return}
    this.tracking=true;
    const b=document.getElementById('btnTrack');b.className='action-btn btn-tracking';b.textContent='â¹ ×¢×¦×•×¨ ××¢×§×‘';
    this.wId=navigator.geolocation.watchPosition(p=>this.onPos(p),()=>{if(!this.drMode&&this.pos)this.activateDR()},{enableHighAccuracy:true,timeout:8000,maximumAge:2000});
    this.fbW=navigator.geolocation.watchPosition(p=>{if(!this.pos||p.coords.accuracy<this.pos.acc*1.5+100)this.onPos(p)},()=>{},{enableHighAccuracy:false,timeout:30000,maximumAge:10000});
    this._drWatchdog=setInterval(()=>{if(this.tracking&&this.pos&&!this.drMode&&(Date.now()-this.lastGPSTime)>10000)this.activateDR()},2000);
    this.toast('ğŸ“¡ ××¢×§×‘ ××™×§×•× ×¤×¢×™×œ');
  },

  stopTrack(){
    this.tracking=false;
    if(this.wId!==null){navigator.geolocation.clearWatch(this.wId);this.wId=null}
    if(this.fbW!==null){navigator.geolocation.clearWatch(this.fbW);this.fbW=null}
    if(this._drWatchdog){clearInterval(this._drWatchdog);this._drWatchdog=null}
    this.deactivateDR();
    const b=document.getElementById('btnTrack');b.className='action-btn btn-track';b.textContent='ğŸ›°ï¸ ××¢×§×‘ ×¨×¦×™×£';
    this.toast('××¢×§×‘ ×”×•×¤×¡×§');
  },

  activateDR(){
    if(!this.pos)return;this.drMode=true;
    DR.setAnchor(this.pos.lat,this.pos.lng);if(this.heading!==null)DR.setHeading(this.heading);DR.activate();
    const c=document.getElementById('uCore');if(c){c.style.background='linear-gradient(180deg,#c084fc,#9333ea)';c.style.boxShadow='0 2px 10px rgba(175,82,222,.5)'}
    document.getElementById('drBanner').classList.add('active');
    document.getElementById('searchArea').classList.add('shifted');document.getElementById('sideControls').classList.add('shifted');
    this.setSource('Dead Reckoning','dr');this.toast('ğŸ§­ GPS ××‘×“ â€” Dead Reckoning ×¤×¢×™×œ');
  },

  deactivateDR(){
    this.drMode=false;DR.deactivate();
    const c=document.getElementById('uCore');if(c){c.style.background='linear-gradient(180deg,#1a8fff,#0066e0)';c.style.boxShadow='0 2px 10px rgba(0,122,255,.4)'}
    document.getElementById('drBanner').classList.remove('active');
    document.getElementById('searchArea').classList.remove('shifted');document.getElementById('sideControls').classList.remove('shifted');
    if(this.map.getSource('dr-trail'))this.map.getSource('dr-trail').setData({type:'Feature',geometry:{type:'LineString',coordinates:[]}});
  },

  onPos(p){
    const{latitude:lat,longitude:lng,accuracy:acc,speed:spd,heading:hdg,altitude:alt}=p.coords;
    const now=Date.now();
    const prev=this.hist.length>0?this.hist[this.hist.length-1]:null;
    const spoof=Spoof.check(lat,lng,acc,now,prev);
    if(spoof.spoofed){
      this.showSpoof(spoof.reasons,spoof.severity);
      if(!this.drMode&&(this.pos||Spoof.lastTrusted)){if(Spoof.lastTrusted)DR.setAnchor(Spoof.lastTrusted.lat,Spoof.lastTrusted.lng);this.activateDR();document.getElementById('drTitle').textContent='DR ×¤×¢×™×œ â€” GPS ××©×•×‘×©'}
      this.lastGPSTime=now;return;
    }
    this.hideSpoof();
    const src=this.classify(acc);
    this.pos={lat,lng,acc,spd,hdg,alt,src,t:now};this.lastGPSTime=now;
    this.hist.push({...this.pos});if(this.hist.length>120)this.hist.shift();
    if(this.drMode){this.deactivateDR();this.toast('âœ… GPS ×—×–×¨ â€” ××™×§×•× ××“×•×™×§')}
    DR.setAnchor(lat,lng);this.render();this.hideSplash();
  },

  showSpoof(reasons,sev){document.getElementById('spoofAlert').classList.add('active');document.getElementById('spoofReasons').textContent=reasons.join(' Â· ');document.getElementById('spoofDetail').textContent=(sev==='high'?'ğŸ”´ ×—×•××¨×” ×’×‘×•×”×”':sev==='medium'?'ğŸŸ  ×‘×™× ×•× ×™×ª':'ğŸŸ¡ ×—×©×“')+' â€” ××©×ª××© ×‘××™×§×•× ××—×¨×•×Ÿ ×××™×Ÿ'},
  hideSpoof(){document.getElementById('spoofAlert').classList.remove('active')},

  classify(a){if(a<=15)return{n:'GPS',c:'gps',clr:'green'};if(a<=40)return{n:'GPS/WiFi',c:'gps',clr:'green'};if(a<=150)return{n:'WiFi',c:'cell',clr:'orange'};if(a<=800)return{n:'×¡×œ×•×œ×¨×™',c:'cell',clr:'orange'};return{n:'×¡×œ×•×œ×¨×™ (××©×•×¢×¨)',c:'none',clr:'red'}},

  render(){
    if(!this.pos||!this.ready)return;
    const{lat,lng,acc,spd,hdg,alt,src}=this.pos;
    this.marker.setLngLat([lng,lat]).addTo(this.map);
    if(!this.firstFix){this.firstFix=true;this.map.flyTo({center:[lng,lat],zoom:acc<80?16:acc<400?14:12,duration:1500,pitch:acc<80?45:0})}
    this.setSource(src.n+' ×¤×¢×™×œ',src.c);
    document.getElementById('accChip').textContent=`Â±${Math.round(acc)}m`;
    const ms=document.getElementById('mSrc');ms.textContent=src.n;ms.style.color=src.clr==='green'?'var(--green)':src.clr==='orange'?'var(--orange)':'var(--red)';
    const ma=document.getElementById('mAcc');ma.textContent=Math.round(acc);ma.style.color=acc<50?'var(--green)':acc<200?'var(--orange)':'var(--red)';
    if(spd!==null&&spd>=0)document.getElementById('mSpd').textContent=Math.round(spd*3.6);
    const h=hdg!==null?hdg:this.heading;if(h!==null)document.getElementById('mHdg').textContent=this.heb(h);
    if(alt!==null)document.getElementById('mAlt').textContent=Math.round(alt);
    document.getElementById('mSteps').textContent=DR.steps;
    if(this.dest)this.updateNavInfo();
  },

  renderDR(){
    if(!DR.active||!DR.estimated||!this.ready)return;
    const{lat,lng}=DR.estimated;
    this.marker.setLngLat([lng,lat]);
    this.setSource('Dead Reckoning','dr');
    const da=DR.estAcc();
    document.getElementById('accChip').textContent=`~Â±${da}m`;
    document.getElementById('mSrc').textContent='DR';document.getElementById('mSrc').style.color='var(--purple)';
    document.getElementById('mAcc').textContent='~'+da;document.getElementById('mAcc').style.color='var(--purple)';
    document.getElementById('mSteps').textContent=DR.steps;
    if(DR.trail.length>1&&this.map.getSource('dr-trail')){
      this.map.getSource('dr-trail').setData({type:'Feature',geometry:{type:'LineString',coordinates:DR.trail.map(p=>[p.lng,p.lat])}});
    }
    this.pos={lat,lng,acc:da,spd:null,hdg:null,alt:null,src:{n:'DR',c:'dr',clr:'purple'},t:Date.now()};
    if(this.dest)this.updateNavInfo();DR.updateUI();
  },

  setSource(txt,cls){document.getElementById('pillLabel').textContent=txt;document.getElementById('sourcePill').className='source-pill '+cls},
  heb(h){const d=['×¦×¤×•×Ÿ','×¦×¤×•×Ÿ-××–×¨×—','××–×¨×—','×“×¨×•×-××–×¨×—','×“×¨×•×','×“×¨×•×-××¢×¨×‘','××¢×¨×‘','×¦×¤×•×Ÿ-××¢×¨×‘'];return d[Math.round(h/45)%8]},

  /* â•â•â• Search (Mapbox Geocoding) â•â•â• */
  async search(q){
    if(!q||q.length<2){document.getElementById('resultsList').classList.remove('open');return}
    try{
      const r=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?access_token=${MAPBOX_TOKEN}&country=il&language=he&limit=5`)).json();
      const c=document.getElementById('resultsList');c.innerHTML='';
      if(!r.features||!r.features.length){c.innerHTML='<div class="result-row"><div class="result-text"><div class="result-name">×œ× × ××¦××• ×ª×•×¦××•×ª</div></div></div>';c.classList.add('open');return}
      r.features.forEach(f=>{
        const nm=f.text||f.place_name.split(',')[0];
        const ad=f.place_name.split(',').slice(1,3).join(', ');
        const d=document.createElement('div');d.className='result-row';
        d.innerHTML=`<div class="result-icon">ğŸ“</div><div class="result-text"><div class="result-name">${nm}</div><div class="result-addr">${ad}</div></div>`;
        d.onclick=()=>{this.setDest(f.center[1],f.center[0],nm);c.classList.remove('open');document.getElementById('searchInput').value=nm};
        c.appendChild(d);
      });c.classList.add('open');
    }catch(e){this.toast('âš ï¸ ×©×’×™××” ×‘×—×™×¤×•×©')}
  },

  /* â•â•â• Routing (Mapbox Directions) â•â•â• */
  async setDest(lat,lng,name){
    this.dest={lat,lng,name};
    // Dest marker
    if(this._destMarker)this._destMarker.remove();
    const el=document.createElement('div');
    el.innerHTML=`<div style="background:#007aff;color:white;padding:4px 12px;border-radius:10px;font-size:12px;font-weight:700;font-family:Heebo,sans-serif;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.2);border:2px solid white">${name}</div><div style="width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid #007aff;margin:0 auto"></div>`;
    this._destMarker=new mapboxgl.Marker({element:el,anchor:'bottom'}).setLngLat([lng,lat]).addTo(this.map);

    document.getElementById('navPanel').classList.add('active');
    document.getElementById('navLabel').textContent='× ×™×•×•×˜ ×œ: '+name;
    await this.fetchRoute();
  },

  async fetchRoute(){
    if(!this.pos||!this.dest)return;
    const mode=this.routeMode;
    const url=`https://api.mapbox.com/directions/v5/mapbox/${mode}/${this.pos.lng},${this.pos.lat};${this.dest.lng},${this.dest.lat}?geometries=geojson&overview=full&steps=true&language=he&access_token=${MAPBOX_TOKEN}`;
    try{
      const r=await(await fetch(url)).json();
      if(!r.routes||!r.routes.length){this.toast('×œ× × ××¦× ××¡×œ×•×œ');return}
      const route=r.routes[0];
      // Draw route
      if(this.map.getSource('route')){
        this.map.getSource('route').setData({type:'Feature',geometry:route.geometry});
      }
      // Fit bounds
      const coords=route.geometry.coordinates;
      const bounds=coords.reduce((b,c)=>b.extend(c),new mapboxgl.LngLatBounds(coords[0],coords[0]));
      this.map.fitBounds(bounds,{padding:{top:120,bottom:280,left:60,right:60},duration:1000});

      // Update nav info
      const dist=route.distance;
      const dur=route.duration;
      document.getElementById('navDistance').textContent=dist<1000?Math.round(dist)+' ××˜×¨':(dist/1000).toFixed(1)+' ×§×´×';
      const mins=Math.round(dur/60);
      document.getElementById('navTime').textContent=mins<60?mins+' ×“×§×•×ª':Math.floor(mins/60)+' ×©×¢×³ '+mins%60+' ×“×§×³';
      const b=this.bear(this.pos.lat,this.pos.lng,this.dest.lat,this.dest.lng);
      document.getElementById('navBearing').textContent='×›×™×•×•×Ÿ: '+this.heb(b)+' Â· '+Math.round(b)+'Â°';
    }catch(e){
      console.error('Route error:',e);
      this.toast('âš ï¸ ×©×’×™××” ×‘×—×™×©×•×‘ ××¡×œ×•×œ');
    }
  },

  updateNavInfo(){
    if(!this.pos||!this.dest)return;
    const d=this.dist(this.pos.lat,this.pos.lng,this.dest.lat,this.dest.lng);
    const b=this.bear(this.pos.lat,this.pos.lng,this.dest.lat,this.dest.lng);
    document.getElementById('navDistance').textContent=d<1000?Math.round(d)+' ××˜×¨':(d/1000).toFixed(1)+' ×§×´×';
    document.getElementById('navBearing').textContent='×›×™×•×•×Ÿ: '+this.heb(b)+' Â· '+Math.round(b)+'Â°';
  },

  clearNav(){
    this.dest=null;
    if(this._destMarker){this._destMarker.remove();this._destMarker=null}
    if(this.map.getSource('route'))this.map.getSource('route').setData({type:'Feature',geometry:{type:'LineString',coordinates:[]}});
    document.getElementById('navPanel').classList.remove('active');
    document.getElementById('searchInput').value='';
    document.getElementById('navTime').textContent='';
  },

  dist(a,b,c,d){const R=6371000,p=Math.PI/180,dl=(c-a)*p,dn=(d-b)*p,x=Math.sin(dl/2)**2+Math.cos(a*p)*Math.cos(c*p)*Math.sin(dn/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))},
  bear(a,b,c,d){const p=Math.PI/180,y=Math.sin((d-b)*p)*Math.cos(c*p),x=Math.cos(a*p)*Math.sin(c*p)-Math.sin(a*p)*Math.cos(c*p)*Math.cos((d-b)*p);return(Math.atan2(y,x)*180/Math.PI+360)%360},

  toast(m){const t=document.getElementById('toast');t.textContent=m;t.className='toast show';clearTimeout(this._tt);this._tt=setTimeout(()=>t.classList.remove('show'),4000)},
  hideSplash(){document.getElementById('splash').classList.add('hidden')},
  recenter(){if(this.pos&&this.ready)this.map.flyTo({center:[this.pos.lng,this.pos.lat],zoom:16,pitch:45,duration:800})},

  toggleTraffic(){
    this._trafficVisible=!this._trafficVisible;
    this.map.setLayoutProperty('traffic-line','visibility',this._trafficVisible?'visible':'none');
    const btn=document.getElementById('trafficBtn');
    btn.style.opacity=this._trafficVisible?'1':'0.4';
    this.toast(this._trafficVisible?'ğŸš¦ ×ª× ×•×¢×” ×—×™×” â€” ×¤×¢×™×œ':'ğŸš¦ ×ª× ×•×¢×” ×—×™×” â€” ×›×‘×•×™');
  },

  shareWhatsApp(){
    if(!this.dest){this.toast('âš ï¸ ×‘×—×¨ ×™×¢×“ ×œ×¤× ×™ ×©×™×ª×•×£');return}
    const baseUrl=window.location.origin+window.location.pathname;
    const link=`${baseUrl}?dest=${this.dest.lat},${this.dest.lng}&name=${encodeURIComponent(this.dest.name)}`;
    const text=`ğŸ—ºï¸ × ×•×•×˜ ×œ: ${this.dest.name}\n${link}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`,'_blank');
  },

  _checkSharedLink(){
    const params=new URLSearchParams(window.location.search);
    const dest=params.get('dest');
    const name=params.get('name');
    if(dest){
      const[lat,lng]=dest.split(',').map(Number);
      if(!isNaN(lat)&&!isNaN(lng)){
        const label=name?decodeURIComponent(name):'×™×¢×“ ××©×•×ª×£';
        setTimeout(()=>this.setDest(lat,lng,label),2000);
        document.getElementById('searchInput').value=label;
      }
    }
  },

  events(){
    document.getElementById('btnLocate').onclick=()=>this.locate();
    document.getElementById('btnTrack').onclick=()=>this.startTrack();
    document.getElementById('btnShare').onclick=()=>this.shareWhatsApp();
    document.getElementById('compassBtn').onclick=()=>{
      this._followHeading=!this._followHeading;
      const btn=document.getElementById('compassBtn');
      if(this._followHeading){
        btn.style.background='rgba(0,122,255,0.12)';btn.style.borderColor='rgba(0,122,255,0.3)';
        this.toast('ğŸ§­ ××¤×” ××¡×ª×•×‘×‘×ª ×œ×¤×™ ×›×™×•×•×Ÿ ×”××›×©×™×¨');
      }else{
        btn.style.background='';btn.style.borderColor='';
        this.map.easeTo({bearing:0,pitch:0,duration:500});
        this.toast('ğŸ§­ ××¤×” × ×¢×•×œ×” â€” ×¦×¤×•×Ÿ ×œ××¢×œ×”');
      }
    };
    document.getElementById('recenterBtn').onclick=()=>this.recenter();
    document.getElementById('trafficBtn').onclick=()=>this.toggleTraffic();
    document.getElementById('navDismiss').onclick=()=>this.clearNav();
    // Map long-press / click to set destination
    this.map.on('click',(e)=>{
      // Ignore if clicking on controls area
      if(e.originalEvent.target.closest('.sheet,.topbar,.search-area,.side-controls,.spoof-alert,.dr-banner'))return;
      const{lng,lat}=e.lngLat;
      // Reverse geocode to get address
      fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${MAPBOX_TOKEN}&language=he&limit=1`)
        .then(r=>r.json()).then(data=>{
          const name=data.features&&data.features.length>0?data.features[0].text||data.features[0].place_name.split(',')[0]:`${lat.toFixed(4)}, ${lng.toFixed(4)}`;
          this.setDest(lat,lng,name);
          document.getElementById('searchInput').value=name;
        }).catch(()=>{
          this.setDest(lat,lng,`${lat.toFixed(4)}, ${lng.toFixed(4)}`);
        });
    });
    // Route mode toggle
    document.querySelectorAll('.route-mode').forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll('.route-mode').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        this.routeMode=btn.dataset.mode;
        if(this.dest)this.fetchRoute();
      };
    });
    const si=document.getElementById('searchInput');
    si.oninput=e=>{clearTimeout(this.sTmr);this.sTmr=setTimeout(()=>this.search(e.target.value),350)};
    document.addEventListener('click',e=>{if(!e.target.closest('.search-area'))document.getElementById('resultsList').classList.remove('open')});
  }
};

App.init();
</script>
</body>
</html>
